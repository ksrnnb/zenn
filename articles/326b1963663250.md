---
title: "ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å®Ÿè£…ã—ã¦ã¿ãŸ"
emoji: "ğŸ”‘"
type: "tech"
topics:
  - "golang"
  - "èªè¨¼"
published: true
published_at: "2022-06-27 09:08"
---

# èƒŒæ™¯
2è¦ç´ èªè¨¼ã‚’æœ‰åŠ¹ã«ã—ãŸçŠ¶æ…‹ã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨ãã€ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ6æ¡ã®æ•°å­—ï¼‰ã®å…¥åŠ›ã‚’æ±‚ã‚ã‚‰ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚
ã“ã‚Œã¯ã©ã†ã‚„ã£ã¦å®Ÿè£…ã—ã¦ã„ã‚‹ã‚“ã ã‚ã†ã¨æ°—ã«ãªã£ãŸã®ã§ã€ä»•æ§˜ã‚’èª­ã‚“ã§å®Ÿè£…ã—ã¦ã¿ã¾ã—ãŸã€‚
ä»Šå›å®Ÿè£…ã—ãŸã®ã¯ã€ TOTP(Time-Based One-Time Password) ã¨å‘¼ã°ã‚Œã‚‹ã‚‚ã®ã§ã€ Google Authenticator ãªã©ã®ã‚¢ãƒ—ãƒªã‚’å…¥ã‚Œã‚‹ã¨ã€ç°¡å˜ã«ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã§ãã¾ã™ã€‚


# ã‚³ãƒ¼ãƒ‰
æœ¬è¨˜äº‹ã®ã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰ã«è¨˜è¼‰ã—ã¦ã„ã¾ã™ã€‚
Docker ã‚’èµ·å‹•ã—ã¦ã€ä¸€é€£ã®æµã‚Œã‚’è©¦ã™ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
https://github.com/ksrnnb/otp

# ä»•æ§˜

## TOTP
TOTP ã¯ [RFC6238](https://datatracker.ietf.org/doc/html/rfc6238#section-4.2) ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚

HOTP(HMAC-Based One-Time Password) ã«é–¢ã—ã¦ã¯å¾Œè¿°ã—ã¾ã™ã€‚

```
TOTP = HOTP(K, T)
T = (Current Unix time - T0) / X

K: HOTP ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®ã‚­ãƒ¼
T: HOTP ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®ã‚¿ã‚¤ãƒ ã‚¹ãƒ†ãƒƒãƒ—ã®ã‚«ã‚¦ãƒ³ãƒˆ
T0: ã‚¿ã‚¤ãƒ ã‚¹ãƒ†ãƒƒãƒ—ã®ã‚«ã‚¦ãƒ³ãƒˆã‚’é–‹å§‹ã™ã‚‹Unix æ™‚é–“ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¯0ï¼‰
X: ã‚¿ã‚¤ãƒ ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¯ X = 30ç§’ï¼‰
```

ã‚³ãƒ¼ãƒ‰ã§ã¿ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
```go
// TOTP time step
const timeStepSecond int64 = 30

func New(secret []byte) string {
	return hotp.New(secret, counter())
}

func counter() uint64 {
	return uint64(time.Now().Unix() / timeStepSecond)
}
```

## HOTP
HOTP ã¯ [RFC4226](https://datatracker.ietf.org/doc/html/rfc4226#section-5.2) ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚

ã‚­ãƒ¼ K ã¨ã€ã‚«ã‚¦ãƒ³ã‚¿ C ã‚’ã‚‚ã¨ã« HMAC-SHA-1 ã‚’è¨ˆç®—ã—ã¦ã€ã„ã‚‰ãªã„éƒ¨åˆ†ã‚’åˆ‡ã‚Šæ¨ã¦ã™ã‚‹ã“ã¨ã§ã€ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
TOTP ã®å ´åˆã¯ã€ã‚«ã‚¦ãƒ³ã‚¿ãŒ `T = (Current Unix time - T0) / X` ã§è¨ˆç®—ã—ãŸå€¤ã¨ãªã‚Šã¾ã™ã€‚

```
HOTP(K,C) = Truncate(HMAC-SHA-1(K,C))
```

ã“ã“ã‹ã‚‰ã¯ã€ã“ã® Trancate é–¢æ•°ã®ä¸­èº«ã¯ä½•ã‚’ã—ã¦ã„ã‚‹ã®ã‹ã‚’è©³ã—ãã¿ã¦ã„ãã¾ã™ã€‚

### Step 1
ã¾ãšã¯å˜ç´”ã« HMAC-SHA-1ã€€ã‚’è¨ˆç®—ã—ã¾ã™ã€‚ã“ã®å€¤ã¯ã€å¿…ãš20ãƒã‚¤ãƒˆã«ãªã‚Šã¾ã™ã€‚
```
HS = HMAC-SHA-1(K,C)
```

ã‚³ãƒ¼ãƒ‰ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
ã‚«ã‚¦ãƒ³ã‚¿ã®å€¤ã‚’ []byte ã«å¤‰æ›ã™ã‚‹ãŸã‚ã€ binary ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚

```go
package hotp

import (
	"crypto/hmac"
	"crypto/sha1"
	"encoding/binary"
)

func hmacSha1(secret []byte, counter uint64) []byte {
	mac := hmac.New(sha1.New, secret)

	// uint64 => 8 byte
	byteCounter := make([]byte, 8)
	binary.BigEndian.PutUint64(byteCounter, counter)

	mac.Write(byteCounter)
	return mac.Sum(nil)
}
```

### Step 2
Step 1 ã§è¨ˆç®—ã—ãŸ HMAC-SHA-1 ã‹ã‚‰ã€4ãƒã‚¤ãƒˆã®æ–‡å­—åˆ—ã‚’ç”Ÿæˆã—ã¦ã€æ•´æ•°ã«å¤‰æ›ã—ã¾ã™ã€‚
ã¾ãš4ãƒã‚¤ãƒˆã®æ–‡å­—åˆ—ã‚’ç”Ÿæˆã™ã‚‹æ–¹æ³•ã§ã™ãŒã€ä»•æ§˜ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚
```
DT(String) // String = String[0]...String[19]
   Let OffsetBits be the low-order 4 bits of String[19]
   Offset = StToNum(OffsetBits) // 0 <= OffSet <= 15
   Let P = String[OffSet]...String[OffSet+3]
   Return the Last 31 bits of P
```

HMAC-SHA-1 ã®æœ«å°¾ã®ä¸‹ä½4ãƒ“ãƒƒãƒˆã‚’æ•°å€¤ã«å¤‰æ›ã—ã¦ offset ã¨ã—ã¾ã™ã€‚ï¼ˆHMAC-SHA-1ã¯20ãƒã‚¤ãƒˆãªã®ã§ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®19ã¯æœ«å°¾ã«ç›¸å½“ï¼‰
ãã—ã¦ã€HMAC-SHA-1 ã® offset ~ offset+3 ã®ä½ç½®ã«ç›¸å½“ã™ã‚‹æ–‡å­—åˆ—ã‹ã‚‰ä¸‹ä½31ãƒ“ãƒƒãƒˆã‚’æŠ½å‡ºã™ã‚‹ã€ã¨ã„ã£ãŸæµã‚Œã«ãªã‚Šã¾ã™ã€‚
ã“ã‚Œã§å¾—ã‚‰ã‚ŒãŸ31ãƒ“ãƒƒãƒˆã®å€¤ã‚’æ•´æ•°ã«å¤‰æ›ã—ã¾ã™ã€‚

ã‚³ãƒ¼ãƒ‰ã§ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
ã¾ãšæœ«å°¾ã®æ–‡å­—ã¨ 0xf ã¨ã®è«–ç†ç©ã‚’è¨ˆç®—ã™ã‚‹ã“ã¨ã§ä¸‹ä½4ãƒ“ãƒƒãƒˆã® offset ã‚’æ±‚ã‚ã¾ã™ã€‚
ãã®å¾Œã€offset ~ offset+3 ã®ä¸‹ä½31ãƒ“ãƒƒãƒˆã‚’å–å¾—ã—ã¦ã„ã¾ã™ã€‚

ã“ã“ã§ã¯ä»•æ§˜ã«æ›¸ã„ã¦ã‚ã‚‹ä¾‹ã®ã¨ãŠã‚Šã«å®Ÿè£…ã—ã¦ã„ã¾ã™ãŒã€ `binary.BigEndian.Uint32(hs[offset:offset+4]) & 0x7fffffff` ã®ã»ã†ãŒã‚¤ãƒ¡ãƒ¼ã‚¸ãŒæ¹§ãã‚„ã™ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

```go
func dynamicTruncate(hs []byte) uint32 {
	// get low-order 4 bits of hs[tail]
	// 0xf => 0000 1111
	offset := hs[len(hs)-1] & 0xf

	// get last 31 bits for hs[offset]...hs[offset + 3]
	// 0x7F => 0111 1111
	return uint32(hs[offset]&0x7f)<<24 |
		uint32(hs[offset+1]&0xff)<<16 |
		uint32(hs[offset+2]&0xff)<<8 |
		uint32(hs[offset+3]&0xff)
}
```

### Step 3
ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®æ¡æ•°ã‚’ d ã¨ãŠãã¨ã€Step 2 ã§å¾—ã‚‰ã‚ŒãŸå€¤ã‚’ `10^d` ã§å‰²ã£ãŸä½™ã‚ŠãŒã€æœ€çµ‚çš„ã«å¾—ã‚‰ã‚Œã‚‹ HOTP ã®å€¤ã¨ãªã‚Šã¾ã™ã€‚

ã‚³ãƒ¼ãƒ‰ã§ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
```go
num := dynamicTruncate(hs)
codeNum := num % uint32(math.Pow10(digits))

f := fmt.Sprintf("%%0%dd", digits)
oneTimePassword := fmt.Sprintf(f, code)
```

# å®Ÿéš›ã«ä½¿ã£ã¦ã¿ã‚‹

## Google Authenticator ã®æº–å‚™
ã‚µãƒ³ãƒ—ãƒ«ã‚’ä½¿ã£ãŸå®Ÿéš›ã®ä¾‹ã‚’ [README](https://github.com/ksrnnb/otp#getting-started) ã«æ›¸ã„ãŸã®ã§ã€è©¦ã—ã¦ã¿ã¾ã™ã€‚

ã¾ãšã¯ Google Authenticator ã‚’ã‚¹ãƒãƒ›ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã€QR ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚Šã¾ã™ã€‚
QR ã‚³ãƒ¼ãƒ‰ã§å–å¾—ã§ãã‚‹æ–‡å­—åˆ—ã¯ `otpauth://totp/otp_example?secret=NBSWY3DP` ã¨ãªã£ã¦ãŠã‚Šã€ã“ã®å½¢å¼ã¯ [Google Authenticator Key Uri Format](https://github.com/google/google-authenticator/wiki/Key-Uri-Format) ã«æ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚
ã¡ãªã¿ã« `NBSWY3DP` ã¯ `hello` ã‚’ Base32 ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ãŸæ–‡å­—åˆ—ã«ãªã‚Šã¾ã™ã€‚å®Ÿé‹ç”¨ã™ã‚‹å ´åˆã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã«ãƒ¦ãƒ‹ãƒ¼ã‚¯ã§ãƒ©ãƒ³ãƒ€ãƒ ãªæ–‡å­—åˆ—ã‚’ç”Ÿæˆã—ã¦ã€Base32 ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

![qr code](https://storage.googleapis.com/zenn-user-upload/6f92df460f0b-20220626.png)

## ã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•
`make run` ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¡ä¸Šã’ã¾ã™ã€‚

## ãƒ­ã‚°ã‚¤ãƒ³
localhost:8080 ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€ã¾ãšã¯ ID/Password ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã€‚

![login page](https://storage.googleapis.com/zenn-user-upload/55021a51954b-20220626.png)

| name | value |
| ---- | ---- |
|id|hogehoge|
|password|hogehoge|

ãƒ­ã‚°ã‚¤ãƒ³å¾Œã€ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ±‚ã‚ã‚‰ã‚Œã‚‹ã®ã§ã€Google Authenticator ã§ç”Ÿæˆã•ã‚ŒãŸ6æ¡ã®æ•°å­—ã‚’å…¥åŠ›ã—ã¾ã™ã€‚

![one-time password page](https://storage.googleapis.com/zenn-user-upload/6a9096b3c090-20220626.png)

ã“ã“ã§é€ä¿¡ã•ã‚ŒãŸå€¤ã¨ã€ã‚µãƒ¼ãƒãƒ¼ã§ç”Ÿæˆã•ã‚ŒãŸå€¤ãŒåŒã˜ã‹ã©ã†ã‹ã‚’æ¤œè¨¼ã—ã¦ã€OK ãªã‚‰ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸã¨ãªã‚Šã¾ã™ã€‚

## ç´°ã‹ã„ã¨ã“ã‚
- ï¼‘ã‚¿ã‚¤ãƒ ã‚¹ãƒ†ãƒƒãƒ—åˆ†ã¯å‰ã®ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé€ã‚‰ã‚Œã¦ã‚‚OKã¨ã—ã¦ã„ã‚‹ï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼ãªã©ã®å½±éŸ¿ãŒã‚ã‚‹ãŸã‚ï¼‰
> The validation system should compare OTPs not only with the receiving timestamp but also the past timestamps that are within the transmission delay.
- 1å›ä½¿ç”¨ã—ãŸãƒ¯ãƒ³ã‚¿ã‚¤ãƒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯è¤‡æ•°å›åˆ©ç”¨ã§ããªã„ã‚ˆã†ã«ã—ã¦ã„ã‚‹ï¼ˆä»Šå›ã¯ Redis ã‚’åˆ©ç”¨ï¼‰

# ãã®ä»–
TOTP ã«ã¯ã‚‚ã†å°‘ã—ä»•æ§˜ãŒã‚ã£ã¦ã€å†åŒæœŸãªã©ã®ä»•çµ„ã¿ãŒå¿…è¦ã«ãªã‚Šã¾ã™ãŒã€ä»Šå›ã¯ç°¡ç•¥åŒ–ã®ãŸã‚çœã„ã¦ã„ã¾ã™ã€‚
è©³ç´°ãŒæ°—ã«ãªã£ãŸæ–¹ãŒã„ã¾ã—ãŸã‚‰ã€ä»•æ§˜ã‚’èª­ã‚“ã§ã¿ã‚‹ã¨ã‚ˆã‚Šç†è§£ãŒæ·±ã¾ã‚‹ã¨æ€ã„ã¾ã™ã€‚

# å‚è€ƒ
- [RFC4226](https://datatracker.ietf.org/doc/html/rfc4226)
- [RFC6238](https://datatracker.ietf.org/doc/html/rfc6238)
- [Google Authenticator Key Uri Format](https://github.com/google/google-authenticator/wiki/Key-Uri-Format)